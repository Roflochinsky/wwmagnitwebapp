# Описание данных для отчета АА BLE

Данный документ описывает структуру данных, используемых в системе автоматизированного мониторинга AA_BLE, источники данных и правила их обработки.

## 1. Входные данные (Excel файлы)

Система считывает данные из Excel-файлов, выгружаемых из системы трекинга. Как правило, используется **второй лист** в книге Excel.

### Основные поля

| Имя в системе | Возможные заголовки в Excel | Описание |
| :--- | :--- | :--- |
| **tn_number** | ТН, Табельный номер, tn, tn_number | Табельный номер сотрудника (уникальный идентификатор). |
| **time_only** | Время на объекте, Время, time | Время фиксации метки (форматы HH:MM:SS, HH:MM или Excel Serial). |
| **ble_tag** | BLE-метка, BLE метка, метка, metka, tag | ID конкретного BLE-маячка. |
| **zone_id** | Зона, ID зоны, zone | Цифровой код зоны, в которой находится маячок. |
| **shift_day** | День смены, Дата смены, Дата, shift_day | Дата, к которой относится данная запись. |

> [!NOTE]
> Если заголовки не найдены, система использует **механизм Positional Fallback**, считывая данные по фиксированным индексам колонок: ТН (0), Дата (3), Метка (10), Зона (11), Время (15).

---

## 2. Справочник зон (Zone Names)

Поле `zone_id` преобразуется в человекочитаемое название зоны согласно следующему справочнику:

| ID | Название зоны |
| :---: | :--- |
| 0 | Вне зоны BLE-маячков |
| 1 | Зоны проведения работ |
| 2 | Столовые |
| 3 | Опасные зоны |
| 4 | Курилки |
| 5 | Зоны отдыха |
| 6 | ВЖГ |
| 7 | Туалеты |
| 8 | Остановки автобусов |
| 9 | Административные помещения |
| 10 | Зона выдачи WW |
| 11 | Склад |
| 12 | Мастерские |
| 13 | КПП |

---

## 3. Вспомогательные данные (Google Sheets)

Для формирования полноценного отчета система обогащает данные трекинга информацией из облачных таблиц.

### Журнал BLE
Используется для получения детального описания местоположения маячка.
- **Источник:** Google Sheets.
- **Поля:** Номер метки (Колонка A), Описание/Локация (Колонка D или B).

### Привязка сотрудников
Используется для связи табельного номера с личными данными.
- **Источник:** Google Sheets.
- **Извлекаемые данные:**
    - **ФИО:** для отображения имен в отчетах.
    - **Участок Работ:** для группировки сотрудников по подразделениям.

---

## 4. Особенности обработки

1.  **Ночные смены:** Система автоматически определяет переход через полночь (например, с 23:59 на 00:01) и корректно склеивает таймлайны.
2.  **Округление:** Используется правило **0.51**. Время округляется вверх до минуты, если зафиксировано более 30.6 секунд (0.51 минуты) активности.
3.  **Валидация:**
    - Если у сотрудника более **100 записей с "Меткой 0"** (вне зоны), система выдает предупреждение.
    - Разрывы в данных более **1 минуты** фиксируются и выводятся в лог как подозрительные.
